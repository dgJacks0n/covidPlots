---
title: "COVID 19 Statistics"
author: "Donald Jackson"
date: '`r Sys.Date()`'
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 3
params:
  flagIso3c:
    input: text
    label: Country to highlight
    value: US
---

# Objective

Use Johns Hopkins COVID data to plot cases and deaths worldwide and in selected country.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# get country from input
flagIso3c <- params$flagIso3c

```

```{r packages}
suppressPackageStartupMessages({
  library(tidyverse)
  library(lubridate)
  library(viridis)
  library(plotly)
  library(envDocument)
  library(knitr)
})
```

```{r functions}
source(paste(here::here(), "lib", "getCovidData.R", sep = "/"))
```

# Data
```{r datasets}
# load dataset

data <- getCovidData()

datasource <- attr(data, "url")
datatime <- attr(data, "downloaded")

# check that flagIso3c is in dataset
if( !(flagIso3c %in% data$code)) {
  stop("Highlight country ", flagIso3c, " not found in dataset")
}

# get country code
flagCountry <- filter(data, code == flagIso3c) %>% 
  slice(1) %>% 
  pull(country) 

# define manual color scale
flagColors <- c("red", "grey50")
names(flagColors) <- c(flagIso3c, "Others")

```

Using data downloaded from `r datasource` on `r datatime`.
This data includes cases and deaths through `r max(data$date)`.

# Results

## Worldwide cases

```{r last_cases}
# last reported casenumber and deaths

last <- data %>%
  group_by(country) %>%
  arrange(desc(date)) %>%
  slice(1) %>%
  filter(cases_cum > 0) %>%
  ungroup() 
```

```{r plot_bycountry}
# plot cases, remove uncoded countries
plot_bycountry <- filter(last, !is.na(code)) %>%
  ggplot(aes(x = fct_reorder(country, cases_cum, .desc = T),
             y = cases_cum, 
             color = ifelse(code == flagIso3c, flagIso3c, "Others"))) +
  labs(x = "Country", y = "Confirmed Cases",
       color = "Country",
       title = "Confirmed Cases by Country") +
  scale_color_manual(values = flagColors) +
  stat_identity() +
  scale_y_log10() +
  theme_minimal() +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

plot_bycountry

# make interactive
ggplotly(plot_bycountry, tooltip = c("x", "y"))

```

```{r cases vs population}
# plot confirmed cases vs population

plot_caseVpop <- filter(last, !is.na(code) & !is.na(population)) %>%
  ggplot(aes(x = population, y = cases_cum, fill = code,
             color = ifelse(code == flagIso3c, flagIso3c, "Others"))) +
  stat_smooth(method = "lm", formula = y~ x,
              aes(color = NA, fill = NA),
              color = "black", linetype = "dotted") +
  geom_point() +
  labs(color = "Country",
       title = "Cases vs. Population",
       x = "Total Cases", y = "Population") +
  scale_color_manual(values = flagColors) +
  scale_x_log10() +
  scale_y_log10() +
  theme_minimal() +
  guides(fill = FALSE)

# print static
plot_caseVpop

# make interactive
ggplotly(plot_caseVpop, 
         tooltip = c("confirmed", "population", "iso3c"))

```

```{r deaths vs cases}

p_deathsVcases <- last %>% 
  filter(deaths_cum > 1) %>% 
  ggplot(aes(x = cases_cum, y = deaths_cum, fill = code,
             color = ifelse(code == flagIso3c, flagIso3c, "Others"))) +
  stat_smooth(method = "lm", formula = y ~ x, aes(color = NA, fill = NA)) +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  scale_color_manual(values = flagColors) +
  labs(x = "Cases", y = "Deaths", color = "Country",
       title = "Cumulative Deaths vs Cases") +
  theme_minimal() +
  guides(fill = F)

p_deathsVcases

ggplotly(p_deathsVcases)

```


## Cases in `r flagCountry`

```{r flag_cases}
flagCases <- filter(data, code == flagIso3c & cases_cum > 0)

# plot cases per time
f_caseVday <- flagCases %>%
  ggplot(aes(x = date, y = cases_cum)) +
  scale_y_log10() +
  stat_smooth(method = "lm", formula = y ~ x) +
  geom_point() +
  labs(title = paste(flagCountry, "Cases by Date")) +
  theme_minimal()

ggplotly(f_caseVday)

# plot deaths
f_deathsVday <- flagCases %>%
  filter(deaths > 0) %>%
  ggplot(aes(x = date, y = deaths_cum)) +
  scale_y_log10() +
  stat_smooth(method = "lm", formula = y ~x) +
  geom_point() +
  labs(title = "US Deaths by Date",
       x = "Deaths", y = "Date") +
  theme_minimal()

ggplotly(f_deathsVday)

# plot death rate over time
f_deathRateVday <- flagCases %>%
  filter(deaths_cum > 1) %>%
  ggplot(aes(x = date, y = (deaths_cum/cases_cum))) +
  geom_point(aes(color = log10(cases_cum))) +
  scale_color_viridis() +
  labs(title = paste(flagCountry, "Death Rate by Date"),
       x = "Date", y = "Deaths/Cases", color = "log10(Cases)") +
  theme_minimal()

ggplotly(f_deathRateVday)

```

---
abstract: |
  COVID-19 case data was downloaded from `r datasource` on
  `r format.Date(datatime, "%B %d %Y")`.
  Worldwide there were `r format(sum(last$cases_cum), big.mark = ",")` cases 
  and `r format(sum(last$deaths_cum), big.mark = ",")` deaths as of 
  `r max(last$date)`.
  In `r flagCountry` there were `r format(max(flagCases$cases_cum), big.mark=",")` 
  cases and `r format(max(flagCases$deaths_cum), big.mark = ",")` 
  deaths as of `r max(flagCases$date)`.
---

# System information

```{r environment_info}
kable(env_doc())
```
---
title: "US Covid Rates"
author: "Donald Jackson"
date: '`r Sys.Date()`'
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 3
params:
  highlightState:
    input: text
    label: State to highlight
    value: Massachusetts
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)

# get state to highlight
highlightState <-  params$highlightState
```

# Objective

Generate exploratory visualizations for US COVID-19 infection and death rates using data from the New York Times.

# Procedure

1. Load current state-level case and death data
1. Load current county-level case and death data
1. Load state and county-level population data from 2019 census and join to case and death datasets
1. Load map coordinates for chloropleth maps
1. Plot cases per capita at state level
1. Map cases per capita at county level
1. Plot deaths per capita at state level
1. Plot deats versus cases at state level

```{r packages}

suppressPackageStartupMessages({
  library(tidyverse)
  library(lubridate)
  library(viridis)
  library(plotly)
  library(envDocument)
  library(knitr)
	library(here)
	library(ggToys)

})

```

```{r set_defaults}
# set default ggplot theme
ggplot2::theme_set(theme_dj())

dataDir <- paste(here::here(), "data", sep = "/")
```

## Data


```{r load_caseData}
# load previously downloaded case and death data
caseDataFile <- paste(dataDir, "usCases.Rds", sep = "/")

usData <- readRDS(caseDataFile)

stateData <- usData[["state"]]

countyData <- usData[["county"]]

# later ops don't preserve attributes; cache download time
timestamp <- attr(countyData, "downloaded")

```

Using state-level case data from
`r attr(stateData, "source")` and county-level case data
from `r attr(countyData, "source")` downloaded
`r format.POSIXct(timestamp, "%B %d %y %T")`.

```{r load_population}
# load state and county-level population data

popDir <- paste(dataDir, "usPopulation2019", sep = "/")

# state populations
statePopFile <- paste(popDir, "statePopulations.Rds", sep = "/")

statePopulations <- readRDS(statePopFile)

# add to state data
stateData <- left_join(stateData, 
											 statePopulations %>% select(STATE, population = POPULATION),
											 by = c("fips" = "STATE"))

stateData$casesPer100k <- with(stateData, cases/(population/1e05))

stateData$deathsPer100k <-with(stateData, deaths/(population/1e05))

# county populations
countyPopFile <- paste(popDir, "countyPopulations.Rds", sep = "/")

countyPopulations <- readRDS(countyPopFile)

# merge with cases
countyData <- left_join(countyData, 
												countyPopulations %>% select(FIPS, population = POPULATION),
												by = c("fips" = "FIPS"))

countyData$casesPer100k <- with(countyData,  cases/(population/1e05))

countyData$deathsPer100k <- with(countyData, deaths/(population/1e05))

```

Joined state- and county-level case and death data with 2019 poulation estimates downloaded from
`r attr(statePopulations, "source")` on
`r format.Date(attr(statePopulations, "downloaded"), "%B %d %Y")`.

```{r load_maps}
# pull in previously downloaded US map data from file
usMapFile <- paste(dataDir, "usCountyMap.Rds", sep = "/")

countyMapData <- readRDS(usMapFile)

```

Loaded US County map data from *`r usMapFile`*.
Data was downloaded from `r attr(countyMapData, "source")`
at `r attr(countyMapData, "downloaded")`.



```{r subset_last_stateData}
# get most recent data
lastStateData <- stateData %>%
	group_by(state) %>%
	arrange(desc(date), .by_group = T) %>%
	slice(1) %>%
	ungroup()

# Values for cases and deaths are cumulative, need to get new
stateData <- stateData %>%
	group_by(state) %>%
	arrange(date, .by_group = T) %>%
	mutate(new_cases = cases - lag(cases, default = first(cases)),
				 new_deaths = deaths - lag(deaths, default = first(deaths))) %>%
	ungroup()


```

```{r subset_lastCountyData}
lastCountyData <- countyData %>% 
	group_by(fips) %>%
	arrange(desc(date)) %>%
	slice(1) %>%
	ungroup()
```

# Results

## State-Level

### Cases per 100k People
```{r cases_byStateDate}
# plot cumulative cases by state
casesByState <- lastStateData %>%
	mutate(state = fct_reorder(state, casesPer100k, .desc = F) )%>%
	highlight_key(~state, group = "byState") %>%
	ggplot(aes(x= state, y = casesPer100k)) +
	geom_point() +
	scale_y_log10() +
	scale_x_discrete(expand = expansion(add = 1)) +
	labs(title = "Cumulative Cases per 100k People By State",
			 y = "Cases per 100k People", x = "State") +
	theme(axis.text.x = element_blank(),
				axis.ticks.x = element_blank(),
				panel.grid.minor.x = element_blank(),
				panel.grid.major.x = element_blank())


p_casesByState <- ggplotly(casesByState, tooltip = c("state", "casesPer100k")) %>%
	hide_guides() #%>%
# 		highlight(dynamic = T, selectize = T, persistent = F,
# 						on = "plotly_click",
#   					defaultValues = highlightState)

# p_casesByState

# plot growth in cases by state
caseGrowthByState <- stateData %>%
	highlight_key(~state, group = "byState") %>%
	ggplot(aes(x = date, y = casesPer100k)) +
	geom_line(aes(group = state)) +
	labs(title = "Case Growth By State", 
			 x = "Date", y = "Cases per 100k People") +
	scale_y_log10()

p_caseGrowthByState <- ggplotly(caseGrowthByState) %>%
	hide_guides() #%>%
# 	highlight(dynamic = T, selectize = T, persistent = F,
# 						on = "plotly_click",
#   					defaultValues = highlightState)

# p_caseGrowthByState

subplot(p_casesByState, p_caseGrowthByState,
				widths = c(0.25, 0.75),
				shareX = F, shareY = T,
				which_layout = 1) %>%
			highlight(dynamic = T, selectize = T, persistent = F,
						on = "plotly_click",
  					defaultValues = highlightState)

```

```{r new_cases_by_state}
# plot 3 day rolling average
newCasesState <- stateData %>%
	group_by(state) %>%
	arrange(date, .by_group = T) %>%
	mutate(prev_cases = lag(new_cases, 1), 
				 prev_by2_cases = lag(new_cases, 2)) %>%
	ungroup() %>%
	mutate(rmean_new_cases = 0.1 + select(., new_cases, prev_cases, prev_by2_cases) %>%
				 	rowMeans(., na.rm = T)) %>%
	highlight_key(~state, group = "byState") %>%
	ggplot(aes(x = date, y = rmean_new_cases)) +
	geom_line(aes(group = state)) +
	labs(y = "New Cases (3 day average)", x = "Date",
			 title = "New Cases By State") +
	scale_y_log10()

# newCasesState

p_newCasesState <- ggplotly(newCasesState) %>%
	hide_guides() %>%
	highlight(dynamic = T, selectize = T, persistent = F,
						on = "plotly_click",
						defaultValues = highlightState)

p_newCasesState

```


### US Case Map

```{r caseMap, eval = T}

# get min and max values
min_caserate <- min(floor(na.omit(log10(lastCountyData$casesPer100k + 0.1))))

max_caserate <- max(ceiling(na.omit(log10(lastCountyData$casesPer100k))))

p_caseMap <- plot_ly() 

p_caseMap <- p_caseMap %>% add_trace(
    type= "choroplethmapbox",
    geojson = countyMapData,
    locations = lastCountyData$fips,
    z = log10(lastCountyData$casesPer100k + 0.1),
    colorscale = "Viridis",
    zmin = min_caserate,
    zmax = max_caserate,
    hoverinfo = "text",
    text = paste(lastCountyData$state, "-",
    						 lastCountyData$county, "<br>",
    						 "Cases:", lastCountyData$cases, "<br>",
    						 "Cases per 100k:", signif(lastCountyData$casesPer100k, 3)),
    marker = list(line = list(
    	width = 0),
    	opacity = 0.5
    )
  )


p_caseMap <- p_caseMap %>% layout(
    mapbox = list(
      style = "carto-positron",
      zoom  = 2,
      center = list(lon =  -95.71, lat = 37.09)),
    title = "US Case Rate Map"
)

# title attribute works but tick labels don't
p_caseMap <- p_caseMap %>% 
	colorbar(
		title = "log10 Cases<br>Per 100k",
		tickmode = "array",
		tickvalues = seq(min_caserate, max_caserate, by = 1),
		ticktext = 10^seq(min_caserate, max_caserate, by = 1)
)

p_caseMap 
```

### Deaths per Capita
```{r deaths_byState}
# plot cumulative cases by state
deathsByState <- lastStateData %>%
	mutate(state = fct_reorder(state, deathsPer100k, .desc = T))%>%
	highlight_key(~state, group = "byState") %>%
	ggplot(aes(x = state, 
						 y = deathsPer100k)) +
	geom_point() +
	scale_y_log10() +
	scale_x_discrete(expand = expansion(add = 1)) +
	labs(title = "Total Deaths By State",
			 y = "Deaths per Capia", x = "State") +
	theme(axis.text.x = element_blank(),
				axis.ticks.x = element_blank(),
				panel.grid.minor.x = element_blank(),
				panel.grid.major.x = element_blank())


p_deathsByState <- ggplotly(deathsByState, tooltip = c("state", "deaths")) %>%
	hide_guides() #%>%
	# highlight(dynamic = T, selectize = T, persistent = F,
						# on = "plotly_click",
  					# defaultValues = highlightState)

deathsGrowthByState <- stateData %>%
	highlight_key(~state, group = "byState") %>%
	ggplot(aes(x = date, y = deathsPer100k)) +
	geom_line(aes(group = state)) +
	labs(title = "Death Growth By State", 
			 x = "Date", y = "Deaths per Capita") +
	scale_y_log10()

p_deathsGrowthByState <- ggplotly(deathsGrowthByState) %>%
	hide_guides()

subplot(p_deathsByState, p_deathsGrowthByState,
				widths = c(0.25, 0.75),
				shareX = F, shareY = T,
				which_layout = 1) %>%
			highlight(dynamic = T, selectize = T, persistent = F,
						on = "plotly_click",
  					defaultValues = highlightState)

```

### Fatality Rate By State
```{r state_deathsPerCase}
p_cfrByState <- lastStateData %>%
	filter(deaths > 0) %>%
	highlight_key(~state, group = "byState") %>%
	ggplot(aes(x = cases, y = deaths)) +
	stat_smooth(method = "lm", formula = y ~ x) +
	geom_point() +
	labs(title = "Cumulative Deaths vs. Cases",
			 x = "Cases", y = "Deaths") +
	scale_x_log10() +
	scale_y_log10()

ggplotly(p_cfrByState, tooltip = c("all")) %>%
	hide_guides() %>%
	highlight(dynamic = T, selectize = T, persistent = F,
						on = "plotly_click",
  					defaultValues = highlightState)
```

```{r state_cfrByDate}
p_cfrByStateDate <- stateData %>%
	filter(deaths > 0) %>%
	highlight_key(~state, group = "byState") %>%
	ggplot(aes(x = date, y = (deaths/cases), 
						 group = state)) +
	labs(title = "State Death Rates By Date", x = "Date",
			 y = "Death Rate", color = "log10 Cases") +
	geom_line()

ggplotly(p_cfrByStateDate, tooltip = c("all")) %>%
	hide_guides() %>%
	highlight(dynamic = T, selectize = T, persistent = F,
						on = "plotly_click",
  					defaultValues = highlightState)
```

---
abstract: |
	State and county-level case and death rates were downloaded
	from the New York Times repository on
	`r format.POSIXct(timestamp, "%B %d %y %T")`.
	This data contains `r sum(lastStateData$cases)` cases and
	`r sum(lastStateData$deaths)` deaths in the US.
---

# System information
```{r environment, results = "asis"}
# summarize environment and session info
env_doc("table")
```
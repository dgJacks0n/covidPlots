---
title: "US Covid Rates"
author: "Donald Jackson"
date: '`r Sys.Date()`'
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 3
params:
  highlightState:
    input: text
    label: State to highlight
    value: Massachusetts
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)

# get state to highlight
highlightState <-  params$highlightState
```

# Objective

Generate exploratory visualizations for US COVID-19 infection and death rates using data from the New York Times.

# Procedure

1. Load current state-level case and death data
1. Load current county-level case and death data
1. Load state and county-level population data from 2019 census and join to case and death datasets
1. Load map coordinates for chloropleth maps
1. Plot cases per capita at state level
1. Map cases per capita at county level
1. Plot deaths per capita at state level
1. Plot deats versus cases at state level

```{r packages}

suppressPackageStartupMessages({
  library(tidyverse)
  library(lubridate)
  library(viridis)
  library(plotly)
  library(envDocument)
  library(knitr)
	library(git2r)
	library(here)
	library(ggToys)

})

```

```{r set_defaults}
# set default ggplot theme
ggplot2::theme_set(theme_dj())

dataDir <- paste(here::here(), "data", sep = "/")
```

## Data

Data is compiled by the New York Times and posted to Github at https://github.com/nytimes/covid-19-data.  Data is updated daily.

```{r check_data_status}
nytDir <- paste(dataDir, "nyt_us", sep = "/")

# refresh data if older than 'staleness' hours
staleness <- 24 

# need to add code to check if data is current.
# right now I'm pulling it in as a submodule.
lastDataCommit <- git2r::last_commit(nytDir)

commitTime <- as.POSIXct(lastDataCommit$author$when)

age <- as.numeric((Sys.time() - commitTime), units = "hours")

# if data is old, update data and time
if(age >= staleness) {
	git2r::pull(nytDir)
	
	lastDataCommit <- git2r::last_commit(nytDir)

	commitTime <- as.POSIXct(lastDataCommit$author$when)

}

```

Using case and death data from
`r format.Date(commitTime, format = "%B %d %Y %T", tz = "", usetz = T)`

```{r load_stateData}
# load state-level data
stateFile <- paste(nytDir, "us-states.csv", sep  =  "/")

stateData <- read.csv(stateFile, header = T, stringsAsFactors = F)

# convert date
stateData$date <- as.Date(stateData$date, format = "%Y-%m-%d")
```



```{r load_county_data}
# load cases by county
countyDataFile <- paste(nytDir, "us-counties.csv", sep = "/")

countyData <- read.csv(countyDataFile, header = T, stringsAsFactors = F,
											 colClasses = c("fips"="character"))

countyData$date <- as.Date(countyData$date, format = "%Y-%m-%d")
```

```{r load_population}
# load state and county-level population data

popDir <- paste(dataDir, "usPopulation2019", sep = "/")

# state populations
statePopFile <- paste(popDir, "statePopulations.Rds", sep = "/")

statePopulations <- readRDS(statePopFile)

# add to state data
stateData <- left_join(stateData, 
											 statePopulations %>% select(STATE, population = POPULATION),
											 by = c("fips" = "STATE"))

stateData <- mutate(stateData, casesPerCapita = cases/population,
										deathsPerCapita = deaths/population)

# county populations
countyPopFile <- paste(popDir, "countyPopulations.Rds", sep = "/")

countyPopulations <- readRDS(countyPopFile)

# merge with cases
countyData <- left_join(countyData, 
												countyPopulations %>% select(FIPS, population = POPULATION),
												by = c("fips" = "FIPS"))

countyData <- mutate(countyData, casesPerCapita = cases/population,
										deathsPerCapita = deaths/population)

```

Joined state- and county-level case and death data with 2019 poulation estimates downloaded from
`r attr(statePopulations, "source")` on
`r format.Date(attr(statePopulations, "downloaded"), "%B %d %Y")`.

```{r load_maps}
# pull in previously downloaded US map data from file
usMapFile <- paste(dataDir, "usCountyMap.Rds", sep = "/")

countyMapData <- readRDS(usMapFile)

```

Loaded US County map data from *`r usMapFile`*.
Data was downloaded from `r attr(countyMapData, "source")`
at `r attr(countyMapData, "downloaded")`.



```{r subset_last_stateData}
# get most recent data
lastStateData <- stateData %>%
	group_by(state) %>%
	arrange(desc(date), .by_group = T) %>%
	slice(1) %>%
	ungroup()

# Values for cases and deaths are cumulative, need to get new
stateData <- stateData %>%
	group_by(state) %>%
	arrange(date, .by_group = T) %>%
	mutate(new_cases = cases - lag(cases, default = first(cases)),
				 new_deaths = deaths - lag(deaths, default = first(deaths))) %>%
	ungroup()


```

```{r subset_lastCountyData}
lastCountyData <- countyData %>% 
	group_by(fips) %>%
	arrange(desc(date)) %>%
	slice(1) %>%
	ungroup()
```

# Results

## State-Level

### Cases per Capita
```{r cases_byStateDate}
# plot cumulative cases by state
casesByState <- lastStateData %>%
	mutate(state = fct_reorder(state, casesPerCapita, .desc = F) )%>%
	highlight_key(~state, group = "byState") %>%
	ggplot(aes(x= state, y = casesPerCapita)) +
	geom_point() +
	scale_y_log10() +
	scale_x_discrete(expand = expansion(add = 1)) +
	labs(title = "Cumulative Cases Per Capita By State",
			 y = "Cases per Capita", x = "State") +
	theme(axis.text.x = element_blank(),
				axis.ticks.x = element_blank(),
				panel.grid.minor.x = element_blank(),
				panel.grid.major.x = element_blank())


p_casesByState <- ggplotly(casesByState, tooltip = c("state", "casesPerCapita")) %>%
	hide_guides() #%>%
# 		highlight(dynamic = T, selectize = T, persistent = F,
# 						on = "plotly_click",
#   					defaultValues = highlightState)

# p_casesByState

# plot growth in cases by state
caseGrowthByState <- stateData %>%
	highlight_key(~state, group = "byState") %>%
	ggplot(aes(x = date, y = casesPerCapita)) +
	geom_line(aes(group = state)) +
	labs(title = "Case Growth By State", 
			 x = "Date", y = "Cases per Capita") +
	scale_y_log10()

p_caseGrowthByState <- ggplotly(caseGrowthByState) %>%
	hide_guides() #%>%
# 	highlight(dynamic = T, selectize = T, persistent = F,
# 						on = "plotly_click",
#   					defaultValues = highlightState)

# p_caseGrowthByState

subplot(p_casesByState, p_caseGrowthByState,
				widths = c(0.25, 0.75),
				shareX = F, shareY = T,
				which_layout = 1) %>%
			highlight(dynamic = T, selectize = T, persistent = F,
						on = "plotly_click",
  					defaultValues = highlightState)

```

```{r new_cases_by_state}
# plot 3 day rolling average
newCasesState <- stateData %>%
	group_by(state) %>%
	arrange(date, .by_group = T) %>%
	mutate(prev_cases = lag(new_cases, 1), 
				 prev_by2_cases = lag(new_cases, 2)) %>%
	ungroup() %>%
	mutate(rmean_new_cases = 0.1 + select(., new_cases, prev_cases, prev_by2_cases) %>%
				 	rowMeans(., na.rm = T)) %>%
	highlight_key(~state, group = "byState") %>%
	ggplot(aes(x = date, y = rmean_new_cases)) +
	geom_line(aes(group = state)) +
	labs(y = "New Cases (3 day average)", x = "Date",
			 title = "New Cases By State") +
	scale_y_log10()

# newCasesState

p_newCasesState <- ggplotly(newCasesState) %>%
	hide_guides() %>%
	highlight(dynamic = T, selectize = T, persistent = F,
						on = "plotly_click",
						defaultValues = highlightState)

p_newCasesState

```


### US Per Capita Case Map

```{r caseMap, eval = T}

p_caseMap <- plot_ly() 

p_caseMap <- p_caseMap %>% add_trace(
    type= "choroplethmapbox",
    geojson = countyMapData,
    locations = lastCountyData$fips,
    z = log10(lastCountyData$casesPerCapita),
    colorscale = "Viridis",
    zmin = -1,
    zmax = -5,
    marker = list(line = list(
      width = 0),
      opacity = 0.5
    )
  )

p_caseMap <- p_caseMap %>% layout(
    mapbox = list(
      style = "carto-positron",
      zoom  = 2,
      center = list(lon =  -95.71, lat = 37.09))
)

p_caseMap
```

### Deaths per Capita
```{r deaths_byState}
# plot cumulative cases by state
deathsByState <- lastStateData %>%
	mutate(state = fct_reorder(state, deathsPerCapita, .desc = T))%>%
	highlight_key(~state, group = "byState") %>%
	ggplot(aes(x = state, 
						 y = deathsPerCapita)) +
	geom_point() +
	scale_y_log10() +
	scale_x_discrete(expand = expansion(add = 1)) +
	labs(title = "Total Deaths By State",
			 y = "Deaths per Capia", x = "State") +
	theme(axis.text.x = element_blank(),
				axis.ticks.x = element_blank(),
				panel.grid.minor.x = element_blank(),
				panel.grid.major.x = element_blank())


p_deathsByState <- ggplotly(deathsByState, tooltip = c("state", "deaths")) %>%
	hide_guides() #%>%
	# highlight(dynamic = T, selectize = T, persistent = F,
						# on = "plotly_click",
  					# defaultValues = highlightState)

deathsGrowthByState <- stateData %>%
	highlight_key(~state, group = "byState") %>%
	ggplot(aes(x = date, y = deathsPerCapita)) +
	geom_line(aes(group = state)) +
	labs(title = "Death Growth By State", 
			 x = "Date", y = "Deaths per Capita") +
	scale_y_log10()

p_deathsGrowthByState <- ggplotly(deathsGrowthByState) %>%
	hide_guides()

subplot(p_deathsByState, p_deathsGrowthByState,
				widths = c(0.25, 0.75),
				shareX = F, shareY = T,
				which_layout = 1) %>%
			highlight(dynamic = T, selectize = T, persistent = F,
						on = "plotly_click",
  					defaultValues = highlightState)

```

### Fatality Rate By State
```{r state_deathsPerCase}
p_cfrByState <- lastStateData %>%
	filter(deaths > 0) %>%
	highlight_key(~state, group = "byState") %>%
	ggplot(aes(x = cases, y = deaths)) +
	stat_smooth(method = "lm", formula = y ~ x) +
	geom_point() +
	labs(title = "Cumulative Deaths vs. Cases",
			 x = "Cases", y = "Deaths") +
	scale_x_log10() +
	scale_y_log10()

ggplotly(p_cfrByState, tooltip = c("all")) %>%
	hide_guides() %>%
	highlight(dynamic = T, selectize = T, persistent = F,
						on = "plotly_click",
  					defaultValues = highlightState)
```

```{r state_cfrByDate}
p_cfrByStateDate <- stateData %>%
	filter(deaths > 0) %>%
	highlight_key(~state, group = "byState") %>%
	ggplot(aes(x = date, y = (deaths/cases), 
						 group = state)) +
	labs(title = "State Death Rates By Date", x = "Date",
			 y = "Death Rate", color = "log10 Cases") +
	geom_line()

ggplotly(p_cfrByStateDate, tooltip = c("all")) %>%
	hide_guides() %>%
	highlight(dynamic = T, selectize = T, persistent = F,
						on = "plotly_click",
  					defaultValues = highlightState)
```

---
abstract: |
	State and county-level case and death rates were downloaded
	from the New York Times repository on
	`r format.Date(commitTime, format = "%B %d %Y")`.
	This data contains `r sum(lastStateData$cases)` cases and
	`r sum(lastStateData$deaths)` deaths in the US.
---

# System information
```{r environment, results = "asis"}
# summarize environment and session info
env_doc("table")
```
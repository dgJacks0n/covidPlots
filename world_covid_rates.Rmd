---
title: "COVID 19 Statistics"
author: "Donald Jackson"
date: '`r Sys.Date()`'
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 3
params:
  flagIso3c:
    input: text
    label: Country to highlight
    value: US
---

# Objective

Use Johns Hopkins COVID data to plot cases and deaths worldwide and in selected country.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE)

# get country from input
flagIso3c <- params$flagIso3c

```

```{r packages}
suppressPackageStartupMessages({
  library(tidyverse)
  library(lubridate)
  library(viridis)
  library(plotly)
  library(envDocument)
  library(knitr)
})
```

```{r functions}
source(paste(here::here(), "lib", "getCovidData.R", sep = "/"))

theme_set(theme_minimal())
```

# Data
```{r datasets}
# load dataset

data <- getCovidData()

datasource <- attr(data, "url")
datatime <- attr(data, "downloaded")

# check that flagIso3c is in dataset
if( !(flagIso3c %in% data$code)) {
  stop("Highlight country ", flagIso3c, " not found in dataset")
}

# get country code
flagCountry <- filter(data, code == flagIso3c) %>% 
  slice(1) %>% 
  pull(country) 

# format for printing
flagCountryPretty <- gsub("_", " ", flagCountry)
flagCountryPretty <- sub("^United", "The United", flagCountryPretty)

# last reported casenumber and deaths

last <- data %>%
  group_by(country) %>%
  arrange(desc(date)) %>%
  slice(1) %>%
  filter(cases_cum > 0) %>%
  ungroup() 

# define manual color scale: red for country of interest, grey for others
flagColors <- rep("grey50", nrow(last))

names(flagColors) <- last$country

flagColors[flagCountry] <- "red"
```

Using data downloaded from `r datasource` on `r datatime`.
This data includes cases and deaths through `r max(data$date)`.

# Results

## Worldwide Cases

### Cumulative Cases


```{r plot_cases_country}
# plot cases, remove uncoded countries
plot_bycountry <- filter(last, !is.na(country)) %>%
  highlight_key(~country, group = "lastData") %>%
  ggplot(aes(x = fct_reorder(country, cases_cum, .desc = T),
             y = cases_cum, 
             color = country)) +
  labs(x = "Country", y = "Confirmed Cases",
       color = "Country",
       title = "Confirmed Cases by Country") +
  scale_color_manual(values = flagColors) +
  stat_identity() +
  scale_y_log10() +
  guides(color = FALSE) +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank())

# plot_bycountry

# make interactive
ggplotly(plot_bycountry, tooltip = c("country", "y")) %>%
  hide_guides() %>%
  highlight(dynamic = T, selectize = T, persistent = T,
            on = "plotly_selected")

```

### Cases vs. Time

```{r plot_cases_v_time, message = F}
# plot cumulative cases vs time.  Adjust to start at day of first case

cases_v_time <- data %>%
  filter(!is.na(d_from_first_case)) %>%
  highlight_key(~country, group = "lastData") %>%
  ggplot(., 
       aes(x = d_from_first_case, y = cases_cum,
           color = country)) + 
  geom_line() + 
  scale_y_log10() +
  labs(x = "Days From First Case", y = "Cases", color = "Country",
       title = "Cases Over Time") +
  scale_color_manual(values = flagColors) +
  guides(color = FALSE)

# cases_v_time

ggplotly(cases_v_time) %>% 
  hide_legend() %>%
  highlight(dynamic = T, selectize = T, persistent = T,
            on = "plotly_selected")
```

### Cases vs. Population


```{r cases_vs_population}
# plot confirmed cases vs population

plot_caseVpop <- filter(last, !is.na(population)) %>%
  highlight_key(~country, group = "lastData") %>%
  ggplot(aes(x = population, y = cases_cum, 
             color = country)) +
  stat_smooth(method = "lm", formula = y~ x,
               aes(color = NA),
               color = "black", linetype = "dotted") +
  geom_point() +
  labs(color = "Country",
       title = "Cases vs. Population",
       y = "Total Cases", x = "Population") +
  scale_color_manual(values = flagColors) +
  scale_x_log10() +
  scale_y_log10() +
  theme_minimal() +
  guides(color = FALSE)

# print static
# plot_caseVpop

# make interactive
ggplotly(plot_caseVpop,
  tooltip = c("cases_cum", "population", "country")) %>% 
  hide_legend() %>%
  highlight(dynamic = T, selectize = T, persistent = T,
            on = "plotly_selected")

```

### Deaths vs. Population

```{r deaths_vs_population}
# plot deaths vs population

plot_deathsVpop <- filter(last, !is.na(country) & 
                            !is.na(population) & 
                            deaths_cum > 0) %>%
  highlight_key(~country, group = "lastData") %>%
  ggplot(aes(x = population, y = deaths_cum,
             color = country)) +
  stat_smooth(method = "lm", formula = y~ x,
              aes(color = NA), color = "black") +
  geom_point() +
  labs(color = "Country",
       title = "Deaths vs. Population",
       y = "Total Deaths", x = "Population") +
  scale_color_manual(values = flagColors) +
  scale_x_log10() +
  scale_y_log10() +
  theme_minimal() +
  guides(color = FALSE)

# print static
# plot_deathsVpop

# make interactive
ggplotly(plot_deathsVpop) %>% 
  hide_guides() %>%
  highlight(dynamic = T, selectize = T, persistent = T,
            on = "plotly_selected")


```

### Deaths vs. Cases

```{r deaths vs cases}

p_deathsVcases <- last %>% 
  filter(deaths_cum > 1) %>% 
  highlight_key(~country, group = "lastData") %>%
  ggplot(aes(x = cases_cum, y = deaths_cum, 
             color = country)) +
  stat_smooth(method = "lm", formula = y ~ x, aes(color = NA),
              color = "black") +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  scale_color_manual(values = flagColors) +
  labs(x = "Cases", y = "Deaths", color = "Country",
       title = "Cumulative Deaths vs Cases") +
  theme_minimal() +
  guides(color = F)

# p_deathsVcases

ggplotly(p_deathsVcases) %>% 
  hide_guides() %>%
  highlight(dynamic = T, selectize = T, persistent = T,
            on = "plotly_selected")

```


## Cases in `r flagCountryPretty`

### Total Cases By Day

```{r flag_cases}
flagCases <- filter(data, code == flagIso3c & cases_cum > 0)

# plot cases per time
f_caseVday <- flagCases %>%
  ggplot(aes(x = date, y = cases_cum)) +
  scale_y_log10() +
  stat_smooth(method = "lm", formula = y ~ x) +
  geom_point() +
  labs(title = paste("Cumulative Cases by Date In", flagCountryPretty),
       y = "Cases", x = "Date") 

ggplotly(f_caseVday)

```

### New Cases Per Day
```{r flag_new_cases}

f_newCaseVDay <- 
  flagCases %>%
  ggplot(aes(x = date, y = cases + 0.1)) +
  stat_smooth(method = "loess", formula = "y ~ x") +
  geom_point() +
  scale_y_log10() +
  labs(title = paste("New Cases by Date In", flagCountryPretty),
       y = "Cases", x = "Date") 

ggplotly(f_newCaseVDay)

```

### Total Deaths per Day

```{r plot_deaths_per_day}
# plot deaths
f_deathsVday <- flagCases %>%
  filter(deaths > 0) %>%
  ggplot(aes(x = date, y = deaths_cum)) +
  scale_y_log10() +
  stat_smooth(method = "lm", formula = y ~x) +
  geom_point() +
  labs(title = paste("Cumulative Deaths by Date In", flagCountryPretty),
       y = "Deaths", x = "Date") +
  theme_minimal()

ggplotly(f_deathsVday)

```

### Death Rate Over Time

``` {r plot_deathrate}
# plot death rate over time
f_deathRateVday <- flagCases %>%
  filter(deaths_cum > 1) %>%
  ggplot(aes(x = date, y = (deaths_cum/cases_cum))) +
  geom_point(aes(color = log10(cases_cum))) +
  scale_color_viridis() +
  labs(title = paste("Death Rate by Date In", flagCountryPretty),
       x = "Date", y = "Deaths/Cases", color = "log10(Cases)") +
  theme_minimal()

ggplotly(f_deathRateVday)

```

---
abstract: |
  COVID-19 case data was downloaded from `r datasource` on
  `r format.Date(datatime, "%B %d %Y")`.
  Worldwide there were `r format(sum(last$cases_cum), big.mark = ",")` cases 
  and `r format(sum(last$deaths_cum), big.mark = ",")` deaths as of 
  `r max(last$date)`.
  In `r flagCountryPretty` there were `r format(max(flagCases$cases_cum), big.mark=",")` 
  cases and `r format(max(flagCases$deaths_cum), big.mark = ",")` 
  deaths as of `r max(flagCases$date)`.
---

# System information

```{r environment_info}
kable(env_doc())
```